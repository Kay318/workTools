"""
복잡한 스크립트 패턴 매칭 검증 프로그램
- 한 엑셀 행에 여러 스크립트 가능
- Level3 생략 가능
- .py 앞에 숫자 있을 수 있음
"""

import os
import re
import pandas as pd
import xlwings as xw
from pathlib import Path
from typing import List, Dict, Set, Optional, Tuple
import warnings
warnings.filterwarnings('ignore')

class ComplexScriptValidator:
    def __init__(self, excel_path: str, scripts_folder: str):
        """
        복잡한 패턴 검증기 초기화
        """
        self.excel_path = excel_path
        self.scripts_folder = scripts_folder
        self.raw_data = None
        self.filtered_data = None
        self.filters = []
        self.expected_scripts = []  # 각 행별 예상 스크립트 리스트
        self.found_scripts = []     # 실제 찾은 스크립트
        self.matched_results = []   # 매칭 결과
        
    def read_excel_data(self, header_row: int = 2) -> pd.DataFrame:
        """
        엑셀 데이터 읽기 (2행이 헤더)
        """
        print("엑셀 파일 읽는 중...")
        
        try:
            app = xw.App(visible=False)
            wb = app.books.open(self.excel_path)
            sheet = wb.sheets['NAVI']
            
            # 2행이 헤더
            df = sheet.range(f'A{header_row}').options(
                pd.DataFrame, 
                header=1, 
                index=False, 
                expand='table',
                mangle_dupe_cols=True
            ).value
            
            wb.close()
            app.quit()
            
        except Exception as e:
            print(f"xlwings 실패: {e}")
            try:
                df = pd.read_excel(self.excel_path, engine='openpyxl')
            except Exception as e2:
                print(f"openpyxl 실패: {e2}")
                raise
        
        self.raw_data = df
        print(f"읽은 데이터: {len(df)}행, 컬럼: {list(df.columns)[:10]}...")
        return df
    
    def add_filter(self, column: str, condition, description: str = ""):
        """필터 추가"""
        self.filters.append({
            'column': column,
            'condition': condition,
            'description': description
        })
    
    def apply_filters(self) -> pd.DataFrame:
        """필터 적용"""
        if self.raw_data is None:
            self.read_excel_data()
        
        df = self.raw_data.copy()
        
        for i, filt in enumerate(self.filters, 1):
            col = filt['column']
            cond = filt['condition']
            desc = filt['description']
            
            if col not in df.columns:
                print(f"경고: 컬럼 '{col}' 없음. 건너뜀")
                continue
                
            if callable(cond):
                mask = df[col].apply(cond)
            elif isinstance(cond, list):
                mask = df[col].isin(cond)
            elif isinstance(cond, str) and cond == 'notnull':
                mask = df[col].notna()
            elif isinstance(cond, str) and cond == 'isnull':
                mask = df[col].isna()
            else:
                mask = df[col] == cond
            
            before = len(df)
            df = df[mask]
            after = len(df)
            print(f"{i}. {desc}: {before} → {after} 행")
        
        self.filtered_data = df
        print(f"필터링 완료: {len(df)} 행")
        return df
    
    def generate_expected_script_patterns(self, row: pd.Series) -> List[str]:
        """
        한 행에서 가능한 모든 스크립트 패턴 생성
        
        패턴 예시:
        1. IBD_CAT_L1_L2_L3__.py      # Level3 있음
        2. IBD_CAT_L1_L2__.py         # Level3 없음
        3. IBD_CAT_L1_L2_L3_1.py      # 숫자 접미사 있음
        4. IBD_CAT_L1_L2_1.py         # Level3 없고 숫자 있음
        5. IBD_CAT_L1__.py            # Level2, Level3 없음
        """
        patterns = []
        
        # 기본 값 가져오기
        category = str(row['category2']).strip() if pd.notna(row.get('category2')) else ""
        level1 = str(row['Level1']).strip() if pd.notna(row.get('Level1')) else ""
        level2 = str(row['Level2']).strip() if pd.notna(row.get('Level2')) else ""
        level3 = str(row['Level3']).strip() if pd.notna(row.get('Level3')) else ""
        
        if not category or not level1:
            return patterns  # 최소 category2와 Level1은 필요
        
        # 모든 조합 생성
        base_parts = [category, level1]
        
        # 1. Level2 있고 Level3 있는 경우
        if level2 and level3:
            # IBD_CAT_L1_L2_L3__.py
            patterns.append(f"IBD_{'_'.join([category, level1, level2, level3])}__.py")
            # IBD_CAT_L1_L2_L3_1.py (숫자 접미사)
            for i in range(1, 6):  # 1~5까지
                patterns.append(f"IBD_{'_'.join([category, level1, level2, level3])}_{i}.py")
        
        # 2. Level2 있고 Level3 없는 경우
        if level2 and not level3:
            # IBD_CAT_L1_L2__.py
            patterns.append(f"IBD_{'_'.join([category, level1, level2])}__.py")
            # IBD_CAT_L1_L2_1.py (숫자 접미사)
            for i in range(1, 6):
                patterns.append(f"IBD_{'_'.join([category, level1, level2])}_{i}.py")
        
        # 3. Level2 없고 Level3 있는 경우 (드물지만)
        if not level2 and level3:
            # IBD_CAT_L1_L3__.py
            patterns.append(f"IBD_{'_'.join([category, level1, level3])}__.py")
            for i in range(1, 6):
                patterns.append(f"IBD_{'_'.join([category, level1, level3])}_{i}.py")
        
        # 4. Level2, Level3 모두 없는 경우
        if not level2 and not level3:
            # IBD_CAT_L1__.py
            patterns.append(f"IBD_{'_'.join([category, level1])}__.py")
            for i in range(1, 6):
                patterns.append(f"IBD_{'_'.join([category, level1])}_{i}.py")
        
        # 중복 제거
        unique_patterns = []
        for pattern in patterns:
            if pattern not in unique_patterns:
                unique_patterns.append(pattern)
        
        return unique_patterns
    
    def find_all_scripts(self) -> Dict[str, Dict]:
        """
        모든 스크립트 찾기 (파일명 → 정보 매핑)
        """
        script_dict = {}
        
        for root, dirs, files in os.walk(self.scripts_folder):
            for file in files:
                if file.endswith('.py'):
                    file_path = os.path.join(root, file)
                    rel_path = os.path.relpath(file_path, self.scripts_folder)
                    
                    # 파일명에서 정보 추출
                    file_info = self._extract_info_from_filename(file)
                    
                    script_dict[file] = {
                        'file_name': file,
                        'file_path': file_path,
                        'relative_path': rel_path,
                        'folder': root,
                        'extracted_info': file_info
                    }
        
        self.found_scripts = script_dict
        print(f"찾은 스크립트: {len(script_dict)}개")
        return script_dict
    
    def _extract_info_from_filename(self, filename: str) -> Dict:
        """
        파일명에서 정보 추출 (정규표현식으로 다양한 패턴 처리)
        """
        # 패턴 정의
        patterns = [
            # IBD_category_L1_L2_L3__.py
            r'^IBD_([^_]+)_([^_]+)_([^_]+)_([^_]+)__\.py$',
            # IBD_category_L1_L2__.py  
            r'^IBD_([^_]+)_([^_]+)_([^_]+)__\.py$',
            # IBD_category_L1__.py
            r'^IBD_([^_]+)_([^_]+)__\.py$',
            # IBD_category_L1_L2_L3_1.py (숫자 접미사)
            r'^IBD_([^_]+)_([^_]+)_([^_]+)_([^_]+)_(\d+)\.py$',
            # IBD_category_L1_L2_1.py
            r'^IBD_([^_]+)_([^_]+)_([^_]+)_(\d+)\.py$',
            # IBD_category_L1_1.py
            r'^IBD_([^_]+)_([^_]+)_(\d+)\.py$',
        ]
        
        for pattern in patterns:
            match = re.match(pattern, filename)
            if match:
                groups = match.groups()
                result = {'pattern': pattern}
                
                if len(groups) >= 2:
                    result['category2'] = groups[0]
                    result['Level1'] = groups[1]
                
                if len(groups) >= 3:
                    # 숫자일 수도 있고 Level2일 수도 있음
                    if groups[2].isdigit():
                        result['suffix_num'] = groups[2]
                    else:
                        result['Level2'] = groups[2]
                
                if len(groups) >= 4:
                    if groups[3].isdigit():
                        result['suffix_num'] = groups[3]
                    else:
                        result['Level3'] = groups[3]
                
                if len(groups) >= 5 and groups[4].isdigit():
                    result['suffix_num'] = groups[4]
                
                return result
        
        # 패턴 매칭 안 되면 기본 정보만
        return {'raw_name': filename.replace('.py', '')}
    
    def validate_all_rows(self) -> List[Dict]:
        """
        모든 행 검증 실행
        """
        if self.filtered_data is None:
            self.apply_filters()
        
        if not self.found_scripts:
            self.find_all_scripts()
        
        print("\n행별 스크립트 검증 시작...")
        
        results = []
        for idx, row in self.filtered_data.iterrows():
            excel_row_num = idx + 3  # 엑셀 행 번호 (헤더 2행 + 1)
            
            # 이 행에서 예상되는 모든 스크립트 패턴
            expected_patterns = self.generate_expected_script_patterns(row)
            
            # 실제 존재하는 스크립트 찾기
            found_for_row = []
            for pattern in expected_patterns:
                if pattern in self.found_scripts:
                    found_for_row.append({
                        'script_name': pattern,
                        'path': self.found_scripts[pattern]['relative_path']
                    })
            
            # 결과 저장
            row_result = {
                '엑셀_행': excel_row_num,
                'category2': row.get('category2', ''),
                'Level1': row.get('Level1', ''),
                'Level2': row.get('Level2', ''),
                'Level3': row.get('Level3', ''),
                '예상_패턴_수': len(expected_patterns),
                '발견_스크립트_수': len(found_for_row),
                '모두_있음': len(found_for_row) >= 1,  # 최소 하나라도 있으면 OK
                '예상_패턴들': expected_patterns,
                '발견_스크립트들': found_for_row,
                '상태': '✓ 있음' if found_for_row else '✗ 없음'
            }
            
            # 추가 컬럼 정보
            for col in ['ccIC', '미국', '자동화 매뉴얼 구분']:
                if col in row:
                    row_result[col] = row[col]
            
            results.append(row_result)
        
        self.matched_results = results
        
        # 통계
        total_rows = len(results)
        rows_with_script = len([r for r in results if r['발견_스크립트_수'] > 0])
        total_expected = sum(r['예상_패턴_수'] for r in results)
        total_found = sum(r['발견_스크립트_수'] for r in results)
        
        print(f"\n검증 완료:")
        print(f"  - 검증 행: {total_rows}")
        print(f"  - 스크립트 있는 행: {rows_with_script}/{total_rows} ({rows_with_script/total_rows*100:.1f}%)")
        print(f"  - 총 예상 패턴: {total_expected}")
        print(f"  - 총 발견 스크립트: {total_found}")
        
        return results
    
    def generate_detailed_report(self, output_path: str = None) -> str:
        """
        상세 리포트 생성
        """
        if output_path is None:
            base_name = os.path.splitext(os.path.basename(self.excel_path))[0]
            timestamp = pd.Timestamp.now().strftime('%Y%m%d_%H%M%S')
            output_path = f"상세_검증_결과_{base_name}_{timestamp}.xlsx"
        
        results = self.validate_all_rows() if not self.matched_results else self.matched_results
        
        with pd.ExcelWriter(output_path, engine='openpyxl') as writer:
            # 1. 요약 시트
            self._create_summary_sheet(writer, results)
            
            # 2. 행별 상세 결과
            self._create_row_detail_sheet(writer, results)
            
            # 3. 누락된 항목
            self._create_missing_sheet(writer, results)
            
            # 4. 발견된 스크립트 전체 목록
            self._create_all_scripts_sheet(writer)
            
            # 5. 필터 조건
            self._create_filter_sheet(writer)
        
        print(f"\n리포트 생성 완료: {output_path}")
        return output_path
    
    def _create_summary_sheet(self, writer, results):
        """요약 시트 생성"""
        summary_data = []
        
        # 기본 통계
        total_rows = len(results)
        rows_with_script = len([r for r in results if r['발견_스크립트_수'] > 0])
        rows_without_script = total_rows - rows_with_script
        
        summary_data.append(['총 검증 행 수', total_rows])
        summary_data.append(['스크립트 있는 행', rows_with_script])
        summary_data.append(['스크립트 없는 행', rows_without_script])
        summary_data.append(['검증률', f'{rows_with_script/total_rows*100:.1f}%'])
        
        # 카테고리별 통계
        categories = {}
        for r in results:
            cat = r.get('category2', 'Unknown')
            if cat not in categories:
                categories[cat] = {'total': 0, 'with_script': 0}
            categories[cat]['total'] += 1
            if r['발견_스크립트_수'] > 0:
                categories[cat]['with_script'] += 1
        
        summary_data.append(['', ''])
        summary_data.append(['카테고리별 통계', ''])
        for cat, stats in sorted(categories.items()):
            if stats['total'] > 0:
                rate = stats['with_script']/stats['total']*100
                summary_data.append([f"  {cat}", f"{stats['with_script']}/{stats['total']} ({rate:.1f}%)"])
        
        df_summary = pd.DataFrame(summary_data, columns=['구분', '값'])
        df_summary.to_excel(writer, sheet_name='요약', index=False)
    
    def _create_row_detail_sheet(self, writer, results):
        """행별 상세 결과"""
        detail_data = []
        
        for r in results:
            # 예상 패턴들을 문자열로
            expected_str = '\n'.join(r['예상_패턴들']) if r['예상_패턴들'] else ''
            
            # 발견 스크립트들을 문자열로
            found_str = '\n'.join([f"{s['script_name']} ({s['path']})" 
                                  for s in r['발견_스크립트들']]) if r['발견_스크립트들'] else ''
            
            detail_data.append({
                '행번호': r['엑셀_행'],
                'category2': r['category2'],
                'Level1': r['Level1'],
                'Level2': r.get('Level2', ''),
                'Level3': r.get('Level3', ''),
                'ccIC': r.get('ccIC', ''),
                '미국': r.get('미국', ''),
                '구분': r.get('자동화 매뉴얼 구분', ''),
                '예상패턴수': r['예상_패턴_수'],
                '발견스크립트수': r['발견_스크립트_수'],
                '상태': r['상태'],
                '예상_패턴들': expected_str,
                '발견_스크립트들': found_str
            })
        
        df_detail = pd.DataFrame(detail_data)
        df_detail.to_excel(writer, sheet_name='행별_상세', index=False)
    
    def _create_missing_sheet(self, writer, results):
        """누락된 항목"""
        missing_data = []
        
        for r in results:
            if r['발견_스크립트_수'] == 0:  # 스크립트 하나도 없으면
                missing_data.append({
                    '행번호': r['엑셀_행'],
                    'category2': r['category2'],
                    'Level1': r['Level1'],
                    'Level2': r.get('Level2', ''),
                    'Level3': r.get('Level3', ''),
                    '예상패턴': '\n'.join(r['예상_패턴들']),
                    'ccIC': r.get('ccIC', ''),
                    '미국': r.get('미국', ''),
                    '구분': r.get('자동화 매뉴얼 구분', '')
                })
        
        if missing_data:
            df_missing = pd.DataFrame(missing_data)
            df_missing.to_excel(writer, sheet_name='누락_항목', index=False)
        else:
            pd.DataFrame(['모든 행에 스크립트가 있습니다.']).to_excel(
                writer, sheet_name='누락_항목', index=False, header=False
            )
    
    def _create_all_scripts_sheet(self, writer):
        """모든 스크립트 목록"""
        script_data = []
        
        for script_name, info in self.found_scripts.items():
            script_data.append({
                '파일명': script_name,
                '경로': info['relative_path'],
                '폴더': info['folder'],
                'category2': info['extracted_info'].get('category2', ''),
                'Level1': info['extracted_info'].get('Level1', ''),
                'Level2': info['extracted_info'].get('Level2', ''),
                'Level3': info['extracted_info'].get('Level3', ''),
                '숫자접미사': info['extracted_info'].get('suffix_num', '')
            })
        
        if script_data:
            df_scripts = pd.DataFrame(script_data)
            df_scripts.to_excel(writer, sheet_name='전체_스크립트', index=False)
    
    def _create_filter_sheet(self, writer):
        """필터 조건"""
        filter_data = []
        
        for i, f in enumerate(self.filters, 1):
            filter_data.append({
                '번호': i,
                '컬럼': f['column'],
                '조건': str(f['condition']),
                '설명': f['description']
            })
        
        if filter_data:
            df_filters = pd.DataFrame(filter_data)
            df_filters.to_excel(writer, sheet_name='적용_필터', index=False)


# 사용 예시
if __name__ == "__main__":
    # 검증기 생성
    validator = ComplexScriptValidator(
        excel_path="path/to/your/excel.xlsx",
        scripts_folder="path/to/scripts"
    )
    
    # 필터 조건 추가
    validator.add_filter("ccIC", "O", "ccIC이 O인 항목")
    validator.add_filter("미국", "O", "미국이 O인 항목")
    validator.add_filter("자동화 매뉴얼 구분", 
                        lambda x: x in ["자동화", "통화"], 
                        "자동화 또는 통화")
    
    # 검증 실행 및 리포트 생성
    report_path = validator.generate_detailed_report()
    print(f"검증 완료! 리포트: {report_path}")
